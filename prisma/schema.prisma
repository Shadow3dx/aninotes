generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  username     String   @unique
  passwordHash String
  role         String   @default("EDITOR")
  image        String?
  bio          String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  posts        Post[]
  comments     Comment[]
  animeEntries     AnimeEntry[]     @relation("UserAnimeEntries")
  mangaEntries     MangaEntry[]     @relation("UserMangaEntries")
  profileComments  ProfileComment[] @relation("ProfileComments")
  commentedOn      ProfileComment[] @relation("ProfileCommentAuthor")
  conversations1   Conversation[]   @relation("Conversations1")
  conversations2   Conversation[]   @relation("Conversations2")
  sentMessages     Message[]        @relation("SentMessages")
  following        Follow[]         @relation("Following")
  followers        Follow[]         @relation("Followers")
  reactions        Reaction[]
  notifications    Notification[]   @relation("NotificationRecipient")
  notificationsActed Notification[] @relation("NotificationActor")
  entryHistory     EntryHistory[]
}

model Post {
  id              String         @id @default(cuid())
  title           String
  slug            String         @unique
  excerpt         String?
  contentMarkdown String
  coverImage      String?

  // Review type
  reviewType    String    @default("ANIME")

  // Anime-specific fields
  animeTitle    String?
  episodeNumber Int?
  season        String?

  // Manga-specific fields
  mangaTitle    String?
  chapterNumber Int?

  // Shared
  rating        Int

  status      String    @default("DRAFT")
  publishAt   DateTime?
  publishedAt DateTime?

  authorId String
  author   User @relation(fields: [authorId], references: [id])

  tags       PostTag[]
  categories PostCategory[]
  comments   Comment[]
  reactions  Reaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([publishedAt])
  @@index([animeTitle])
  @@index([reviewType])
}

model Comment {
  id         String   @id @default(cuid())
  body       String
  authorName String
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  postId     String
  post       Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  parentId   String?
  parent     Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    Comment[] @relation("CommentReplies")
  createdAt  DateTime @default(now())

  @@index([postId])
  @@index([parentId])
}

model Tag {
  id    String    @id @default(cuid())
  name  String    @unique
  slug  String    @unique
  posts PostTag[]
}

model Category {
  id    String         @id @default(cuid())
  name  String         @unique
  slug  String         @unique
  posts PostCategory[]
}

model AnimeEntry {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation("UserAnimeEntries", fields: [userId], references: [id], onDelete: Cascade)
  malId           Int
  title           String
  imageUrl        String?
  synopsis        String?   @db.Text
  totalEpisodes   Int?
  mediaType       String?
  airingStatus    String?
  malScore        Float?
  status          String    @default("PLAN_TO_WATCH")
  score           Int?
  episodesWatched Int       @default(0)
  isFavorite      Boolean   @default(false)
  notes           String?   @db.Text
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, malId])
  @@index([userId])
  @@index([userId, status])
}

model MangaEntry {
  id               String    @id @default(cuid())
  userId           String
  user             User      @relation("UserMangaEntries", fields: [userId], references: [id], onDelete: Cascade)
  malId            Int
  title            String
  imageUrl         String?
  synopsis         String?   @db.Text
  totalChapters    Int?
  totalVolumes     Int?
  mediaType        String?
  publishingStatus String?
  malScore         Float?
  status           String    @default("PLAN_TO_READ")
  score            Int?
  chaptersRead     Int       @default(0)
  volumesRead      Int       @default(0)
  isFavorite       Boolean   @default(false)
  notes            String?   @db.Text
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([userId, malId])
  @@index([userId])
  @@index([userId, status])
}

model PostTag {
  postId String
  tagId  String
  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag    Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
}

model PostCategory {
  postId     String
  categoryId String
  post       Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([postId, categoryId])
}

model ProfileComment {
  id        String           @id @default(cuid())
  body      String
  userId    String
  user      User             @relation("ProfileCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  profileId String
  profile   User             @relation("ProfileComments", fields: [profileId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    ProfileComment?  @relation("ProfileCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   ProfileComment[] @relation("ProfileCommentReplies")
  createdAt DateTime         @default(now())

  @@index([profileId])
  @@index([parentId])
}

model Conversation {
  id             String    @id @default(cuid())
  participant1Id String
  participant1   User      @relation("Conversations1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2Id String
  participant2   User      @relation("Conversations2", fields: [participant2Id], references: [id], onDelete: Cascade)
  messages       Message[]
  updatedAt      DateTime  @updatedAt
  createdAt      DateTime  @default(now())

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  body           String       @db.Text
  readAt         DateTime?
  createdAt      DateTime     @default(now())

  @@index([conversationId, createdAt])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  follower    User     @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String
  following   User     @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Reaction {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  type      String
  createdAt DateTime @default(now())

  @@unique([userId, postId, type])
  @@index([postId])
}

model Notification {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  type          String
  relatedUserId String?
  relatedUser   User?     @relation("NotificationActor", fields: [relatedUserId], references: [id], onDelete: SetNull)
  relatedPostId String?
  body          String
  readAt        DateTime?
  createdAt     DateTime  @default(now())

  @@index([userId, readAt])
  @@index([createdAt])
}

model EntryHistory {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  entryType  String
  entryTitle String
  field      String
  oldValue   Int
  newValue   Int
  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
}
